{{/*
Pre-upgrade hook to safely migrate sub-apps from App CRs to HelmReleases.

Uses operatorkit's paused annotation to prevent race conditions with both
app-operator and chart-operator during the migration:

Phase 1: Pause all App CRs (prevents app-operator from recreating Chart CRs)
Phase 2: Pause + remove finalizers + delete Chart CRs (prevents chart-operator
         from re-adding finalizers or uninstalling Helm releases)
Phase 3: Remove finalizers + delete App CRs

All sub-apps in this bundle are remote (deployed to WC via kubeconfig),
so their Chart CRs live on the WC in the giantswarm namespace.
*/}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $.Values.clusterID }}-migrate-security-apps
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "labels.common" $ | nindent 4 }}
  annotations:
    ignore-check.kube-linter.io/no-read-only-root-fs: "Need to store kubeconfig files"
    helm.sh/hook: pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "labels.common" $ | nindent 8 }}
    spec:
      serviceAccountName: {{ $.Values.clusterID }}-migrate-security-apps
      restartPolicy: Never
      containers:
      - name: kubectl
        image: gsoci.azurecr.io/giantswarm/kubectl:1.25.16
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
            - ALL
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 256Mi
        command:
        - /bin/sh
        - -c
        - |
          set -eu
          CLUSTER_NAME="{{ $.Values.clusterID }}"
          NAMESPACE="{{ $.Release.Namespace }}"
          CHART_NAMESPACE="giantswarm"

          # Fetch WC kubeconfig (all sub-apps are remote, Chart CRs on WC)
          echo "Fetching WC kubeconfig for $CLUSTER_NAME"
          kubectl get secret -n "$NAMESPACE" "${CLUSTER_NAME}-kubeconfig" \
            -o jsonpath='{.data.value}' | base64 -d > /tmp/wc-kubeconfig

          WC="--kubeconfig /tmp/wc-kubeconfig"

          # Helper: remove finalizers and delete an App CR.
          # This prevents app-operator from recreating Chart CRs
          # between the Chart CR cleanup and the Helm upgrade.
          delete_app() {
            local app_name="$1"

            if ! kubectl get apps.application.giantswarm.io "$app_name" -n "$NAMESPACE" > /dev/null 2>&1; then
              echo "  App CR $app_name not found, skipping"
              return
            fi

            echo "  Removing finalizers from App CR $app_name"
            kubectl patch apps.application.giantswarm.io "$app_name" -n "$NAMESPACE" --type=json \
              -p='[{"op": "remove", "path": "/metadata/finalizers"}]' 2>/dev/null || \
              echo "  No finalizers to remove or already deleted"

            echo "  Deleting App CR $app_name"
            kubectl delete apps.application.giantswarm.io "$app_name" -n "$NAMESPACE" --ignore-not-found=true
          }

          # Helper: pause, remove finalizers, and delete a Chart CR.
          # The paused annotation prevents chart-operator from re-adding
          # its finalizer (race condition) and from uninstalling the Helm release.
          cleanup_chart() {
            local target="$1"
            local chart_name="$2"
            local location="$3"

            if ! kubectl $target get chart "$chart_name" -n "$CHART_NAMESPACE" > /dev/null 2>&1; then
              echo "  Chart CR $chart_name not found on $location, skipping"
              return
            fi

            echo "  Pausing chart-operator reconciliation for $chart_name on $location"
            kubectl $target annotate chart "$chart_name" -n "$CHART_NAMESPACE" \
              "operatorkit.giantswarm.io/paused=true" --overwrite 2>/dev/null || \
              echo "  Failed to pause, continuing anyway"

            echo "  Removing finalizers from Chart CR $chart_name on $location"
            kubectl $target patch chart "$chart_name" -n "$CHART_NAMESPACE" --type=json \
              -p='[{"op": "remove", "path": "/metadata/finalizers"}]' 2>/dev/null || \
              echo "  No finalizers to remove or already deleted"

            echo "  Deleting Chart CR $chart_name on $location"
            kubectl $target delete chart "$chart_name" -n "$CHART_NAMESPACE" --ignore-not-found=true
          }

          # --- Phase 1: Pause all App CRs ---
          # Prevents app-operator from reconciling and recreating Chart CRs
          # during cleanup. Uses operatorkit's paused annotation.
          ALL_APPS="
            ${CLUSTER_NAME}-cloudnative-pg
            ${CLUSTER_NAME}-exception-recommender
            ${CLUSTER_NAME}-falco
            ${CLUSTER_NAME}-gel
            ${CLUSTER_NAME}-jiralert
            ${CLUSTER_NAME}-kubescape
            ${CLUSTER_NAME}-kyverno
            ${CLUSTER_NAME}-kyverno-crds
            ${CLUSTER_NAME}-kyverno-policies
            ${CLUSTER_NAME}-kyverno-policy-operator
            ${CLUSTER_NAME}-policy-api-crds
            ${CLUSTER_NAME}-reports-server
            ${CLUSTER_NAME}-starboard-exporter
            ${CLUSTER_NAME}-trivy
            ${CLUSTER_NAME}-trivy-operator
          "
          echo "Phase 1: Pausing all App CRs to prevent app-operator reconciliation"
          for APP_CR in $ALL_APPS; do
            APP_CR=$(echo "$APP_CR" | tr -d '[:space:]')
            [ -z "$APP_CR" ] && continue
            if kubectl get apps.application.giantswarm.io "$APP_CR" -n "$NAMESPACE" > /dev/null 2>&1; then
              echo "  Pausing App CR $APP_CR"
              kubectl annotate apps.application.giantswarm.io "$APP_CR" -n "$NAMESPACE" \
                "operatorkit.giantswarm.io/paused=true" --overwrite 2>/dev/null || true
            fi
          done

          # --- Phase 2: Clean up Chart CRs ---

          # --- Remote apps (Chart CRs on WC) ---
          # Chart CR name = app name (cluster prefix stripped by app-operator)
          REMOTE_APPS="
            cloudnative-pg
            exception-recommender
            falco
            gel
            jiralert
            kubescape
            kyverno
            kyverno-crds
            kyverno-policies
            kyverno-policy-operator
            policy-api-crds
            reports-server
            starboard-exporter
            trivy
            trivy-operator
          "

          for APP in $REMOTE_APPS; do
            APP=$(echo "$APP" | tr -d '[:space:]')
            [ -z "$APP" ] && continue

            echo "Processing remote app: $APP"
            cleanup_chart "$WC" "$APP" "WC"
          done

          # --- Phase 3: Delete App CRs ---
          # App CRs were already paused in Phase 1, so app-operator won't
          # interfere. Removing finalizers and deleting completes the cleanup.
          echo "Phase 3: Deleting App CRs"
          for APP_CR in $ALL_APPS; do
            APP_CR=$(echo "$APP_CR" | tr -d '[:space:]')
            [ -z "$APP_CR" ] && continue
            delete_app "$APP_CR"
          done

          echo "Security bundle migration hook completed successfully"
